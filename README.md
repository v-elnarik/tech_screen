# Техническое описание проекта

## 1. Назначение проекта

Проект представляет собой систему технического скрининга кандидатов, состоящую из следующих компонентов:

- **Бэкенд API** — REST-интерфейс для управления вопросами теста и результатами тестирования.
- **Telegram-бот** — интерактивное прохождение теста кандидатом с фиксацией ответов.
- **База данных** — хранение данных о вопросах теста и результатах прохождения для дальнейшего анализа.

Основная идея проекта — автоматизировать предварительную оценку кандидатов посредством тестирования через Telegram и предоставить рекрутерам удобный интерфейс для работы с данными.

---

## 2. Архитектура и используемые технологии

### 2.1. Компоненты проекта

1. **Бэкенд (FastAPI)**
   - **Язык и фреймворк:** Python, FastAPI.
   - **Основные задачи:**
     - Управление вопросами теста: создание, получение, обновление и удаление вопросов.
     - Управление результатами тестирования: получение списка результатов с фильтрацией и сортировкой.
   - **Ключевые библиотеки:**
     - *SQLAlchemy* — для работы с базой данных через ORM.
     - *Pydantic* — для валидации и сериализации данных.
     - *CORSMiddleware* — для обеспечения кросс-доменных запросов (например, с `http://localhost:3000`).

2. **Telegram-бот (aiogram)**
   - **Язык и фреймворк:** Python, aiogram.
   - **Основные задачи:**
     - Проведение интерактивного тестирования кандидата через Telegram.
     - Использование FSM (Finite State Machine) для управления последовательностью вопросов.
     - Подсчет баллов по результатам теста.
     - Сохранение результатов тестирования в базу данных.
   - **Ключевые библиотеки:**
     - *aiogram* — для реализации логики бота и взаимодействия с Telegram API.
     - *dotenv* — для загрузки конфиденциальных переменных (например, токена бота) из `.env` файла.

3. **База данных (PostgreSQL + SQLAlchemy)**
   - **СУБД:** PostgreSQL.
   - **Основные задачи:**
     - Хранение вопросов теста (таблица `questions`).
     - Хранение результатов тестирования (таблица `test_results`).
   - **Модели:**
     - **Question:** хранит текст вопроса, варианты ответов и правильный ответ.
     - **TestResult:** хранит идентификатор, идентификатор пользователя, ответы на вопросы, итоговый балл и метку времени прохождения теста.
   - **Подключение и настройка:**
     - Использование SQLAlchemy для подключения к БД и работы с моделями.
     - Параметры подключения задаются через строку подключения (`DATABASE_URL`).

---

## 3. Детальное описание компонентов

### 3.1. API (api.py)

- **Создание и настройка приложения:**
  - Инициализация приложения FastAPI.
  - Добавление CORS middleware для разрешения запросов с указанного источника (например, `http://localhost:3000`).

- **Работа с базой данных:**
  - Функция `get_db()` используется для создания сессии работы с БД и её последующего закрытия.
  - Автоматическое создание таблиц при старте проекта с помощью `Base.metadata.create_all(bind=engine)`.

- **Эндпоинты для вопросов:**
  - **GET `/questions`:** получение списка вопросов с поддержкой пагинации (параметры `skip` и `limit`).
  - **GET `/questions/{question_id}`:** получение конкретного вопроса по его идентификатору.
  - **POST `/questions`:** создание нового вопроса.
  - **PUT `/questions/{question_id}`:** обновление существующего вопроса.
  - **DELETE `/questions/{question_id}`:** удаление вопроса.

- **Эндпоинты для результатов тестирования:**
  - **GET `/results`:** получение списка результатов с возможностью фильтрации по минимальному/максимальному баллам, диапазону дат и сортировки по полям `score` или `timestamp`.
  - **GET `/results/{result_id}`:** получение конкретного результата по идентификатору.

- **Валидация:**
  - Использование Pydantic-схем (`QuestionSchema`, `TestResultSchema`) для проверки корректности данных при обмене информацией между клиентом и сервером.

---

### 3.2. Telegram-бот (minimal_bot.py)

- **Запуск и инициализация:**
  - Токен бота считывается из файла `.env` с использованием библиотеки `dotenv`.
  - Создаются объекты бота, диспетчера (Dispatcher) и хранилища состояний (MemoryStorage) для работы с FSM.

- **Логика прохождения теста:**
  - **Состояния теста:** Определены состояния `TestStates` для последовательного прохождения трёх вопросов (Q1, Q2, Q3).
  - **Начало теста:** Команда `/start` инициирует тестирование, отправляя первый вопрос с соответствующей клавиатурой для выбора ответа.
  - **Обработка ответов:**
    - Каждый ответ сохраняется в состоянии FSM.
    - После получения ответа бот отправляет следующий вопрос с соответствующими вариантами ответов.
  - **Подсчет результатов:**
    - После последнего вопроса производится подсчет правильных ответов.
    - Результат теста (баллы и ответы) сохраняется в базу данных.
  - **Завершение теста:** После сохранения результатов состояние FSM очищается, что позволяет начать новый тест при необходимости.

---

### 3.3. База данных и модели (db.py)

- **Подключение к базе данных:**
  - Использование SQLAlchemy для подключения к PostgreSQL через строку подключения (`DATABASE_URL`).
  - Создание сессии работы с базой данных с помощью `SessionLocal`.

- **Определение моделей:**
  - **TestResult:**
    - Поля: `id`, `user_id`, `q1`, `q2`, `q3`, `score`, `timestamp`.
    - Значение `timestamp` по умолчанию устанавливается на текущее время (UTC).
  - **Question:**
    - Поля: `id`, `text` (текст вопроса), `options` (варианты ответов, хранящиеся в текстовом формате), `correct` (правильный ответ).

- **Инициализация таблиц:**
  - Автоматическое создание таблиц при импорте модуля с использованием `Base.metadata.create_all(bind=engine)`.

---

## 4. Поток данных и взаимодействие компонентов

1. **Процесс тестирования через Telegram-бота:**
   - Пользователь отправляет команду `/start` боту.
   - Бот переводит пользователя в режим FSM и отправляет первый вопрос с вариантами ответов.
   - После получения ответов на все вопросы бот подсчитывает баллы и отправляет результат пользователю.
   - Результат тестирования сохраняется в таблице `test_results` базы данных.

2. **Доступ к данным через API:**
   - Рекрутер или администратор может запрашивать данные о вопросах и результатах тестов через REST API.
   - Поддерживаются фильтрация и сортировка, что позволяет проводить анализ результатов тестирования (например, по баллам или по времени прохождения).

3. **Интеграция компонентов:**
   - **Telegram-бот** напрямую взаимодействует с базой данных для записи результатов тестирования.
   - **FastAPI** предоставляет REST API для управления данными, что позволяет создавать административные панели или фронтенд для анализа.

---

## 5. Особенности и возможности расширения

- **Валидация данных:**  
  Благодаря использованию Pydantic для API, можно легко расширять валидацию и обрабатывать некорректные данные.

- **Фильтрация и сортировка:**  
  API для результатов тестирования поддерживает динамическую фильтрацию по диапазонам дат и баллам, что упрощает аналитическую работу.

- **Гибкость расширения функционала:**
  - Возможность добавления новых типов вопросов, включая множественный выбор.
  - Расширение функционала Telegram-бота (например, просмотр предыдущих результатов, повторное прохождение теста или интеграция с внешними системами).

- **Масштабируемость:**
  - Возможность перехода на асинхронную модель работы (например, использование асинхронного SQLAlchemy) для повышения производительности.
  - Расширение API для административных целей через добавление новых эндпоинтов.

---

## Заключение

Проект представляет собой интегрированное решение для проведения технического скрининга кандидатов с использованием современных инструментов (FastAPI, aiogram, PostgreSQL). Архитектура системы позволяет легко расширять функциональность и адаптировать систему под новые требования, а гибкая модель работы с данными обеспечивает удобство анализа результатов тестирования.
